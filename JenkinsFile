pipeline {
    agent { label 'lab-server' }

    environment {
        M2_HOME = "/opt/maven"
        PATH = "${M2_HOME}/bin:${env.PATH}"
        JAR_NAME = "target/identityservicesengineer-0.0.1-SNAPSHOT.jar"
        PROCESS_NAME = "identityservicesengineer-0.0.1-SNAPSHOT.jar"
    }

    stages {
        stage('Pull latest code') {
            steps {
                echo 'üì• Pull latest code t·ª´ GitHub (ƒë√£ l√†m t·ª± ƒë·ªông)'
                sh 'pwd && ls -la'
            }
        }

        stage('Build project') {
            steps {
                echo '‚öôÔ∏è Building project b·∫±ng Maven...'
                sh '''
                    mvn -v
                    mvn clean install -DskipTests=true
                '''
            }
        }

        stage('Stop old process') {
            steps {
                echo 'üõë ƒêang d·ª´ng process c≈© (n·∫øu c√≥)...'
                sh '''
                    PID=$(ps -ef | grep "$PROCESS_NAME" | grep -v grep | awk '{print $2}')
                    if [ ! -z "$PID" ]; then
                        kill -9 $PID
                        echo "ƒê√£ kill PID $PID"
                    else
                        echo "Kh√¥ng t√¨m th·∫•y process ƒëang ch·∫°y"
                    fi
                '''
            }
        }

        stage('Run new jar in background') {
            steps {
                echo 'üöÄ ƒêang ch·∫°y l·∫°i app d∆∞·ªõi n·ªÅn...'
                sh '''
                    nohup java -jar $JAR_NAME > app.log 2>&1 &
                    echo "App ƒëang ch·∫°y l·∫°i d∆∞·ªõi n·ªÅn!"
                '''
            }
        }
    }
}
